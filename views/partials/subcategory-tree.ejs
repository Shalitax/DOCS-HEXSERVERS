<% subcategories.forEach((subcategory) => { %>
  <div class="mb-4 ml-4" data-subcategory-id="<%= subcategory.id %>">
    <div class="flex items-center justify-between mb-2 group relative">
      <button onclick="toggleSubcategory(<%= subcategory.id %>)" class="flex items-center flex-1 text-left">
        <i class="fas fa-chevron-down mr-2 text-xs transition-transform subcategory-chevron-<%= subcategory.id %>" id="chevron-sub-<%= subcategory.id %>"></i>
        <% if (subcategory.icon_type === 'image') { %>
          <img src="<%= subcategory.icon %>" alt="" class="w-4 h-4 mr-2 object-contain" onerror="this.style.display='none'">
        <% } else { %>
          <i class="<%= subcategory.icon.includes(' ') ? subcategory.icon : 'fas ' + subcategory.icon %> mr-2 text-xs"></i>
        <% } %>
        <h4 class="text-sm font-medium text-gray-300">
          <%= subcategory.displayName %>
        </h4>
      </button>
      <% if (isAuthenticated) { %>
        <div class="flex flex-row items-center gap-1 opacity-0 group-hover:opacity-100 transition-all duration-200">
          <button onclick="showSubcategoryModal(<%= category.id %>, '<%= category.displayName %>', <%= subcategory.id %>)" class="glass px-2 py-1 rounded hover:bg-green-500/20 text-green-400 text-xs transition-all" title="Nueva Sub-subcategoría">
            <i class="fas fa-plus"></i>
          </button>
          <button onclick="showDocModal(<%= subcategory.id %>)" class="glass px-2 py-1 rounded hover:bg-green-500/20 text-green-400 text-xs transition-all" title="Nueva Documentación">
            <i class="fas fa-file-alt"></i>
          </button>
          <button onclick="editSubcategoryModal(<%= subcategory.id %>, '<%= subcategory.name %>', '<%= subcategory.displayName %>', '<%= subcategory.slug %>', '<%= subcategory.icon %>', <%= subcategory.order_index %>, <%= category.id %>, <%= subcategory.is_hidden ? 1 : 0 %>, '<%= subcategory.icon_type || 'fontawesome' %>', <%= subcategory.parent_subcategory_id || 'null' %>)" class="glass px-2 py-1 rounded hover:bg-blue-500/20 text-blue-400 text-xs transition-all" title="Editar">
            <i class="fas fa-edit"></i>
          </button>
          <button onclick="deleteSubcategory(<%= subcategory.id %>, '<%= subcategory.displayName %>')" class="glass px-2 py-1 rounded hover:bg-red-500/20 text-red-400 text-xs transition-all" title="Eliminar">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      <% } %>
    </div>
    
    <div class="ml-4 subcategory-content" id="subcategory-content-<%= subcategory.id %>">
      <!-- Subcategorías anidadas (recursivo) -->
      <% if (subcategory.subcategories && subcategory.subcategories.length > 0) { %>
        <%- include('subcategory-tree', { subcategories: subcategory.subcategories, category: category, isAuthenticated: isAuthenticated }) %>
      <% } %>
      
      <!-- Documentos -->
      <% if (subcategory.guides && subcategory.guides.length > 0) { %>
        <ul class="space-y-1">
          <% subcategory.guides.forEach(guide => { %>
            <li class="group relative flex items-center">
              <a 
                href="/docs/<%= guide.path %>" 
                class="flex-1 block px-3 py-2 rounded-lg text-gray-300 hover:bg-white/20 hover:text-white transition-all duration-200 text-sm <%= (typeof currentPath !== 'undefined' && currentPath === guide.path) ? 'bg-white/20 text-white font-semibold' : '' %>"
              >
                <i class="fas fa-file-alt mr-2 text-xs"></i>
                <%= guide.title %>
              </a>
              <% if (isAuthenticated) { %>
                <div class="flex flex-row items-center gap-1 opacity-0 group-hover:opacity-100 transition-all duration-200 ml-2">
                  <button onclick="editDocModal(<%= guide.id %>, '<%= (guide.title || '').replace(/'/g, "\\'") %>', '<%= (guide.slug || '') %>', '<%= (guide.description || '').replace(/'/g, "\\'") %>', `<%= (guide.content || '').replace(/`/g, '\\`').replace(/\$/g, '\\$') %>`, <%= guide.order_index || 0 %>)" class="glass px-2 py-1 rounded hover:bg-blue-500/20 text-blue-400 text-xs transition-all" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="deleteDocument(<%= guide.id %>, '<%= guide.title %>')" class="glass px-2 py-1 rounded hover:bg-red-500/20 text-red-400 text-xs transition-all" title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              <% } %>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </div>
  </div>
<% }) %>
